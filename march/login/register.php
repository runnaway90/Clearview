<?	require_once('db_config.php');	require_once('login_functions.php');	session_start();
	$username_not_empty = TRUE;	$username_valid = TRUE;	$username_not_duplicate = TRUE;	$password1_not_empty = TRUE;	$password2_not_empty = TRUE;	$passwords_match = TRUE;	$password_valid = TRUE;	$captcha_valid = TRUE;	$email1_not_empty = TRUE;    $email2_not_empty = TRUE;	$email_valid = TRUE;    $email_uni = TRUE;    $valid_domains = array('ed.ac.uk');    $email_not_duplicate = TRUE;	$emails_match = TRUE;	$fname_not_empty = TRUE;	$fname_valid = TRUE;	$lname_not_empty = TRUE;	$lname_valid = TRUE;    	//check if user is logged in	if (isLoggedIn()) { header('Location: ../main.php'); }
	//check if username and password fields are not empty	if (isset($_POST['username']) && isset($_POST['pass1']) && isset($_POST['pass2']))	{		//connect to the DB		$conn = mysql_connect($dbhost, $dbuser, $dbpass);		mysql_select_db($dbname, $conn);
		//secure data agains code injection		$username = secure_data($_POST['username']);		$pass1 = secure_data($_POST['pass1']);		$pass2 = secure_data($_POST['pass2']);		$email1 = secure_data($_POST['email1']);		$email2 = secure_data($_POST['email2']);		$fname = secure_data($_POST['fname']);		$lname = secure_data($_POST['lname']);		//check if username is not empty		if (empty($username)) { $username_not_empty = FALSE; }        
		//check if username is valid		if ( (!(ctype_alnum($username))) || ((strlen($username)) >15) ) { $username_valid=FALSE; }		//check if user exists		$query = 	"SELECT username					FROM $usertable					WHERE username = '$username';";		$result = mysql_query($query);                // user exists
		if(mysql_num_rows($result) > 0) { $username_not_duplicate=FALSE; }
		// check if fname is empty		if(empty($fname)) { $fname_not_empty = FALSE; }
		// first name verification		// Set up regular expression strings to evaluate the if first name is made of only letters;?
		$regex = '/[a-zA-Z- ]/'; 
		// Run the preg_match() function on regex against the first name address		if (!preg_match($regex, $fname)) { $fname_valid = FALSE; } 
		// check if lname is empty		if (empty($lname)) { $lname_not_empty = FALSE; }
		/// Set up regular expression strings to evaluate the if last name is made of only letters;?		$regex = '/[a-zA-Z]/'; 		// Run the preg_match() function on regex against the last name address		if (!preg_match($regex, $fname)) { $lname_valid = FALSE; } 
		// check if email is empty		if (empty($email1)) { $email1_not_empty = FALSE; }        if (empty($email2)) { $email2_not_empty = FALSE; }                // check if emails match        if (strcmp($email1,$email2) != 0) { $emails_match = FALSE; }        else         {            $email = $email1;
            // email verification            // Set up regular expression strings to evaluate the value of email variable against            $regex = '/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,3})$/'; 
            // Run the preg_match() function on regex against the email address            if (!preg_match($regex, $email)) { $email_valid = FALSE; }            else             {                // check if a uni email                $domain = explode('@',$email);                $domain = $domain[1];                                // match with all valid domains                $email_uni = FALSE;                foreach ($valid_domains as $vd)                {                    $regex = '/\.*'.$vd.'$/';                    if (preg_match($regex, $domain))                     {                        $email_uni = TRUE;                        break;                    }                }
            }            //check if email exists            $query = 	"SELECT email                        FROM $usertable                        WHERE email = '$email';";            $result = mysql_query($query);            if(mysql_num_rows($result) > 0) { $email_not_duplicate=FALSE; }                    } // end of email checks                		//check if password is not empty		if (empty($pass1)) { $password1_not_empty = FALSE; }		if (empty($pass2)) { $password2_not_empty = FALSE; }        		//check if passwords match		if (strcmp($pass1,$pass2) != 0) { $passwords_match=FALSE; }        else         {            $pass = $pass1;
            //check if password is valid	            if (!ctype_alnum($pass) // numbers & digits only                 || !(strlen($pass)>6) // at least 7 chars 
                || !(strlen($pass)<21) // at most 20 chars 
                || !preg_match('`[A-Z]`',$pass) // at least one upper case 
                || !preg_match('`[a-z]`',$pass) // at least one lower case 
                || !preg_match('`[0-9]`',$pass) // at least one digit 
                )
            { 
                $password_valid=FALSE;
            }        }
		//Validate recaptcha		require_once('recaptchalib.php');		$resp = recaptcha_check_answer ($private_captcha_key,										$_SERVER["REMOTE_ADDR"],										$_POST["recaptcha_challenge_field"],										$_POST["recaptcha_response_field"]);        //captcha validation fails
		if (!$resp->is_valid) {	$captcha_valid=FALSE; } 		$dob = $_POST['year'] . '-' . $_POST['month'] . '-' .$_POST['day'];				//check if all variables are true		if ( ($username_not_empty==TRUE)			&& ($username_valid==TRUE)			&& ($username_not_duplicate==TRUE)			&& ($password1_not_empty==TRUE)			&& ($password2_not_empty==TRUE)			&& ($passwords_match==TRUE)			&& ($password_valid==TRUE)			&& ($captcha_valid==TRUE)			&& ($fname_valid==TRUE)			&& ($fname_not_empty==TRUE)			&& ($lname_valid==TRUE)			&& ($lname_not_empty==TRUE)			&& ($email_valid==TRUE)			&& ($email1_not_empty==TRUE)			&& ($email2_not_empty==TRUE)            && ($email_not_duplicate==TRUE)            && ($email_uni==TRUE)            && ($emails_match==TRUE) )		{			//hash the password			$hash = hash('sha256', $pass);						//creates a 3 character sequence			function createSalt()			{				$string = md5(uniqid(rand(), TRUE));				return substr($string, 0, 3);			}			$salt = createSalt();			$hash = hash('sha256', $salt . $hash);			$query = "INSERT INTO $usertable ( username, password, salt, firstname, surname, email, dob )					VALUES ( '$username' , '$hash' , '$salt', '$fname', '$lname', '$email', '$dob' );";			mysql_query($query);			mysql_close();
			$username = "";			//? No idea where to redirect yet			header('Location: login.php');		}	}
	function dateOfBirth($day,$month,$year)  	{  		//Day  		$select_date = 'Date of Birth: <select name="day">';  		for ($i = 1; $i <= 31; $i++) 		{  			$sel='';            if ($day==$i) $sel=' selected="selected"'; 			$select_date .= '<option value="'.$i.'"'.$sel.'>'.$i.'</option>';  
		}  		$select_date .= '</select>';  
		//Month  		$select_date .= '<select name="month">';  		for ($i = 1; $i <= 12; $i++) 		{  			$name = date( 'F', mktime(0, 0, 0, $i) );  			if($i<10) $i = '0'.$i;  			$sel='';  			if($month==$i) $sel=' selected="selected"'; 			$select_date .= '<option value="'.$i.'"'.$sel.'>'.$name.'</option>';  		}  		$select_date .= '</select>';  
		//Year  		$select_date .= '<select name="year">';  		for ($i = date("o"); $i >= date("o")-100; $i--) 		{  			$sel='';  			if($year==$i) $sel=' selected="selected"'; 			$select_date .= '<option value="'.$i.'"'.$sel.'>'.$i.'</option>';  		}  		$select_date .= '</select>';  
		return $select_date;  	}  
?>
<!DOCTYPE HTML>
<html>	<head>		<title>Register as a Valid User</title>		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">		<style type="text/css">.invalid { border: 1px solid #000000; background: #FF00FF; }	</style>
	</head>
	<body >		<h2>User registration Form</h2>		<br />		Please fill in the details below(<i>note that all fields are required</i>)		<br /><br />                <?php // error messages if any ?>            <? if ($captcha_valid==FALSE) echo '<font color="red">Please enter correct captcha</font><br />'; ?>            <? if ($fname_not_empty==FALSE) echo '<font color="red">You have entered an empty fnamr.</font><br />'; ?>            <? if ($fname_valid==FALSE) echo '<font color="red">Your username should be alphanumeric and less than 14 characters.</font><br />'; ?>            <? if ($lname_not_empty==FALSE) echo '<font color="red">You have entered an empty fnamr.</font><br />'; ?>            <? if ($lname_valid==FALSE) echo '<font color="red">Your username should be alphanumeric and less than 14 characters.</font><br />'; ?>            <? if ($username_not_empty==FALSE) echo '<font color="red">You have entered an empty username.</font><br />'; ?>            <? if ($username_valid==FALSE) echo '<font color="red">Your username should be alphanumeric and less than 14 characters.</font><br />'; ?>            <? if ($username_not_duplicate==FALSE) echo '<font color="red">Please choose another username, your username is already used.</font><br />'; ?>            <? if ($email1_not_empty==FALSE) echo '<font color="red">You have entered an empty email.</font><br />'; ?>            <? if ($email2_not_empty==FALSE) echo '<font color="red">You have entered an empty repeat email.</font><br />'; ?>            <? if ($email_valid==FALSE) echo '<font color="red">Your email should be email@provider.domain.</font><br />'; ?>            <? if ($email_uni==FALSE) echo '<font color="red">Your email should be uni.</font><br />'; ?>            <? if ($email_not_duplicate==FALSE) echo '<font color="red">Your email is already registered.</font><br />'; ?>            <? if ($emails_match==FALSE) echo '<font color="red">Your emails do not match.</font><br />'; ?>            <? if ($password1_not_empty==FALSE) echo '<font color="red">Your first password field is empty.</font><br />'; ?>            <? if ($password2_not_empty==FALSE) echo '<font color="red">Your second password field is empty.</font><br />'; ?>            <? if ($password_valid==FALSE) echo '<font color="red">Your password should be alphanumeric and greater 7 characters and less than 20 characters.</font><br />'; ?>            <? if ($passwords_match==FALSE) echo '<font color="red">Your password does not match.</font><br />'; ?>        <?php //end of error messages ?>              		<!-- Start of registration form -->		<form action="<?php echo htmlentities($_SERVER['PHP_SELF']); ?>" method="POST">			First Name:  <input type="text" class="<?php if (($fname_not_empty==FALSE) || ($fname_valid==FALSE))  echo "invalid"; ?>" id="fname" name="fname" value=<? if(isset($fname)) echo '"'.$fname.'"'; ?>> (<i>alphanumeric less than 14 characters</i>)<br /><br />			Last Name:  <input type="text" class="<?php if (($lname_not_empty==FALSE) || ($lname_valid==FALSE))  echo "invalid"; ?>" id="lname" name="lname" value=<? if(isset($lname)) echo '"'.$lname.'"'; ?>> (<i>alphanumeric less than 14 characters</i>)<br /><br />			Username:  <input type="text" class="<?php if (($username_not_empty==FALSE) || ($username_valid==FALSE) || ($username_not_duplicate==FALSE))  echo "invalid"; ?>" id="username" name="username" value=<? if(isset($username)) echo '"'.$username.'"'; ?>> (<i>alphanumeric less than 14 characters</i>)<br /><br />			E-mail:  <input type="text" class="<?php if (($email1_not_empty==FALSE) || ($email_valid==FALSE)) { echo "invalid"; } ?>" id="email1" name="email1" value=<? if(isset($email1)) echo '"'.$email1.'"'; ?>> (<i>please enter a valid uni e-mail</i>)<br /><br />			Repeat e-mail:  <input type="text" class="<?php if (($email2_not_empty==FALSE) || ($email_valid==FALSE)) { echo "invalid"; } ?>" id="email2" name="email2" value=<? if(isset($email2)) echo '"'.$email2.'"'; ?>> (<i>please enter a valid uni e-mail</i>)<br /><br />			<? if (isset($_POST['year'])) { echo dateOfBirth($_POST['day'],$_POST['month'],$_POST['year']); } else { echo dateOfBirth(01,01,1991); } ?> <i> (You must be at least ?? to join) </i> <br /><br />            Password:  <input name="pass1" type="password" class="<?php if (($password1_not_empty==FALSE) || ($passwords_match==FALSE) || ($password_valid==FALSE)) echo "invalid"; ?>" id="pass1" > (<i>alphanumeric greater than 7 characters and less than 20 characters</i>)<br /><br />			Retype password: <input name="pass2" type="password" class="<?php if (($password2_not_empty==FALSE) || ($passwords_match==FALSE) || ($password_valid==FALSE)) echo "invalid"; ?>" id="pass2" ><br /><br />			<br /><br />			Type the captcha below:			<br /> <br />			<?php				require_once('recaptchalib.php');				echo recaptcha_get_html($public_captcha_key);			?>			<br /><br />			<input type="submit" value="Register">			<br /><br />
			<a href="../index.php">Back to Intro page</a><br />        </form>		<!-- End of registration form -->	</body></html>